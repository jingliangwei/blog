# XXE漏洞

主要参考：[xxe漏洞学习](https://0ran9e.fun/2024/06/10/%E5%AD%A6%E4%B9%A0%E6%96%87%E7%AB%A0/xxe%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/)

## XXE漏洞基础

### XXE简介

XXE(XML External Entity Injection)全称为XML外部实体注入，是一种注入漏洞。

### XML基础

XML是可扩展标记语言（Extensible Markup Language），类似html，用于传递数据。

::: details 小细节
Ubuntu 22.04 系统就是以 `xml` 格式保存字体配置信息的，文件路径为 `/etc/fonts/conf.d/64-language-selector-prefer.conf`
:::

#### DTD

一个例子：
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE note [
  <!ELEMENT note (to, from, heading, body)>
  <!ELEMENT to (#PCDATA)>
  <!ELEMENT from (#PCDATA)>
  <!ELEMENT heading (#PCDATA)>
  <!ELEMENT body (#PCDATA)>
]>
<note>
  <to>Tove</to>
  <from>Jani</from>
  <heading>Reminder</heading>
  <body>Don't forget me this weekend!</body>
</note>
```
其中的 `<!DOCTYPE>` 部分是DTD（文档类型定义，Document Type Definition）

也可以把DTD定义放在外部文件，如下：

文件 `note.dtd` 
```xml
<!ELEMENT note (to, from, heading, body)>
<!ELEMENT to (#PCDATA)>
<!ELEMENT from (#PCDATA)>
<!ELEMENT heading (#PCDATA)>
<!ELEMENT body (#PCDATA)>
```

文件 `note.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE note SYSTEM "note.dtd">
<note>
  <to>Tove</to>
  <from>Jani</from>
  <heading>Reminder</heading>
  <body>Don't forget me this weekend!</body>
</note>
```

#### 实体

实体是用于替换文本的机制。

1. 内部实体

示例：
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE note [
  <!ENTITY copyright "© 2025 MyCompany. All rights reserved.">
]>
<note>
  <to>Tove</to>
  <from>Jani</from>
  <heading>Reminder</heading>
  <body>Don't forget me this weekend! &copyright;</body>
</note>
```

2. 外部实体

示例：

文件 `footer.txt` 
```txt
© 2025 MyCompany. All rights reserved.
```

文件 `note.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE note [
  <!ENTITY footer SYSTEM "footer.txt">
]>
<note>
  <to>Tove</to>
  <from>Jani</from>
  <heading>Reminder</heading>
  <body>Don't forget me this weekend!</body>
  <footer>&footer;</footer>
</note>
```

对外部实体的引用有 `SYSTEM` 和 `PUBLIC` 两个关键字，可以使用如下协议
`file:///path/to/file`
`http://url/file`

3. 通用实体 & 参数实体

上面两个例子均为通用实体，还有一种特殊类型的实体为参数实体，它定义于DTD内部，且只能在DTD内部使用。

示例：
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE example [
  <!ENTITY % common_elements "<title>Title</title><description>Description</description>">
  <!ELEMENT example ( %common_elements; )>
]>
<example>
  <title>Sample Title</title>
  <description>Sample Description</description>
</example>
```

通用实体使用 `&name;` 进行引用

参数实体用 `% name` 定义，只能在DTD内使用 `%name;` 进行引用
